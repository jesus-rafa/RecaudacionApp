{% extends 'base_new.html' %}
{% load static %}
{% load tags %}
{% load humanize %}
{% load l10n %}

{% block title %} Autorización {% endblock title %}

{% block head %}
<link href="{% static 'assets/libs/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'assets/libs/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'assets/libs/datatables.net-buttons-bs5/css/buttons.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />
{% endblock head %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box">
            <div class="page-title-right">
                {% if permission == 'EJECUTIVO ANALISIS' %}
                <button id="btNew" onclick="Add_Modal('{% url 'programacion_app:elegir' 1 %}', 0)"
                    class="btn btn-outline-secondary waves-effect btn-volver" target="_blank">
                    <i class="mdi mdi-plus"></i> Agregar Contribuyente
                </button>
                <!-- DON'T TOUCH THIS AGAIN -->
                <button id="btNew" onclick="Agregar_Contribuyente('{% url 'programacion_app:add-contribuyente' %}', 0)"
                    class="btn btn-outline-secondary waves-effect btn-volver" target="_blank">
                    <i class="mdi mdi-plus"></i> Carga Manual
                </button>
                <!-- DON'T TOUCH THIS AGAIN -->
                {% endif %}
            </div>
            <h4 class="page-title">Autorización</h4>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-12 mb-30">
        <div class="card">
            <div class="card-body">
                    <ul class="nav nav-tabs nav-bordered">
                        <li class="nav-item">
                            <a href="#home-20" id="home-20-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link active">
                                Propuestas FAFD
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#profile-30" id="profile-30-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Revision
                            </a>
                        </li>
                        {% if permission == 'EJECUTIVO ANALISIS' %}
                        <li class="nav-item">
                            <a href="#en-proceso" id="en-proceso-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Propuestas de Contribuyentes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#reporte" id="reporte-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Reporte
                            </a>
                        </li>
                        {% elif permission == 'DIRECTOR' %}
                        <li class="nav-item">
                            <a href="#reporte" id="reporte-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Reporte
                            </a>
                        </li>
                        {% elif permission == 'COORDINACION PROGRAMACION' %}
                        <li class="nav-item">
                            <a href="#reporte" id="reporte-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Reporte
                            </a>
                        </li>
						{% elif permission == 'COORDINACION VIGILANCIA' %}
						<li class="nav-item">
                            <a href="#por-cerrar" id="por-cerrar-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Por Cerrar
                            </a>
                        </li>
						<li class="nav-item">
                            <a href="#solicitar-apoyo" id="solicitar-apoyo-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Solicitar Apoyo
                            </a>
                        </li>
						<li class="nav-item">
                            <a href="#reasignar-oficio" id="reasignar-oficio-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Reasignar Oficio
                            </a>
                        </li>
						{% endif %}
						 <li class="nav-item">
                            <a href="#profile-70" id="profile-70-tab" data-bs-toggle="tab" aria-expanded="false"
                                class="nav-link">
                                Canceladas
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade active show" id="home-20">
							
							{% if permission == 'DIRECTOR' %}
								<div class="text-center">
									Ultimo Folio: {% for data in last_folio %}<strong class="text-secondary">{{ data.folio }}</strong>&nbsp;&nbsp;&nbsp;RFC: <strong class="text-secondary">{{ data.rfc }}</strong>{% endfor %}
								</div>
							{% endif %}

                            <div class="text-center">
                                <h5><span class="badge bg-primary"><strong>{{ permission }}</strong></span></h5>
                            </div>

                            <div class="row">
                                <div class="form-floating col-md-12">
                                    <input id="search2" type="text" class="float-label form-control input-rec" placeholder=".">
                                    <label>Buscar</label>
                                </div>
                            </div>

                            <div class="table-responsive pt-3">
                                <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" id="datatable2">
                                    <thead>
                                        <tr>
                                            <td class="all">Oficio</td>
                                            <td class="all">RFC</td>
                                            <td class="all">Nombre</td>								
                                            <td class="all">Programa</td>
                                            <td class="all">Fecha Creación</td>
                                            <td class="all">Estatus</td>
                                            <td class="all">Presuntiva</td>	 
                                            <td class="all hidden-sm">Acciones</td>  
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {% for row in programacion %}
                                        <tr>
                                            <td>
                                                {% if row.estatus == 'OFICIO' %}
                                                {{ row.folio|slice:"-9:" }}
                                                {% else %}
                                                {{ row.id }}
                                                {% endif %}
                                            </td>
                                            <td>{{ row.rfc }}</td>
                                            <td data-bs-toggle="tooltip" data-bs-placement="top" title="{{ row.nombre }}">{{ row.nombre|truncatechars:30 }}</td>
                                            <td>{{ row.programa }}</td>
                                            <td><span class="sp_date">{{ row.fecha|date:'Y/m/d' }}</span> {{ row.fecha|date:'d/m/Y' }}</td>
                                            <td>
                                                {% if row.estatus == '1-RECHAZADA' or row.estatus == '2-RECHAZADA' or row.estatus == '3-RECHAZADA'%}
													RECHAZADA
												{% else %}
													{{ row.estatus }}
												{% endif %}
                                            </td>
                                            <td>$ {{ row.presuntiva|unlocalize|intcomma }}</td>
                                            <td>
                                            <div class="text-center">
                                                <div class="btn-group dropdown">
                                                    <a href="javascript: void(0);" class="table-action-btn dropdown-toggle arrow-none btn btn-light btn-sm"
                                                        data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #00000000; border: 0px solid;"><i class="mdi mdi-dots-horizontal"></i></a>
                                                    <div class="dropdown-menu dropdown-menu-end">

                                                        {% if permission == 'EJECUTIVO ANALISIS' %}
                                                            {% if row.estatus == 'NUEVO' or row.estatus == '1-RECHAZADA' %}
                                                            <a id="btPublish"
                                                                onclick="Publicar('{% url 'programacion_app:asignar' %}', '{{ row.id }}', '{{ row.estatus }}', '{{row.folio}}', 0, '{{row.rfc}}', '{{row.nombre}}', '{{row.direccion}}');"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Publicar</a>
                                                            {% endif %}
                                                            
                                                            <a id="btUpdate"
                                                            onclick="Editar_Contribuyente('{% url 'programacion_app:editar-contribuyente' row.id %}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fas fa-pen me-2 text-muted font-18 vertical-middle"></i>Editar</a>

                                                            <a id="btFile"
                                                            onclick="CargarArchivos('{% url 'programacion_app:subir-archivos-vigilancia' row.id %}', '{{ row.id }}', '{{ row.rfc }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="ti-file me-2 text-muted font-18 vertical-middle"></i>Archivos</a>
                                                        
                                                        {% elif permission == 'COORDINACION PROGRAMACION' %}
                                                            <a id="btPublish"
                                                            onclick="Publicar('{% url 'programacion_app:asignar' %}', '{{ row.id }}', '{{ row.estatus }}', '{{ row.folio}}', 0, '{{row.rfc}}', '{{row.nombre}}', '{{row.direccion}}');"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Publicar</a>

                                                            <a id="btCancel"
                                                            onclick="Cancel_Modal('{% url 'programacion_app:alta-detalle' row.id %}', '{{ row.id }}', '{{ row.folio }}', '{{ row.rfc }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-reply me-2 text-muted font-18 vertical-middle"></i>Rechazar</a>
                                                            
                                                            

                                                        {% elif permission == 'COORDINACION VIGILANCIA' %}
                                                            {% if row.estatus == 'FAFD' or row.estatus == '3-RECHAZADA' %}
                                                                <a id="btPublish"
                                                                onclick="Publicar('{% url 'programacion_app:asignar' %}', '{{ row.id }}', '{{ row.estatus }}', '{{ row.folio}}', 0, '{{row.rfc}}', '{{row.nombre}}', '{{row.direccion}}');"
                                                                    class="dropdown-item" href="#">
                                                                    <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Publicar</a>

                                                                <a id="btCancel"
                                                                onclick="Cancel_Modal('{% url 'programacion_app:alta-detalle' row.id %}', '{{ row.id }}', '{{ row.folio }}', '{{ row.rfc }}')"
                                                                    class="dropdown-item" href="#">
                                                                    <i class="fa fa-reply me-2 text-muted font-18 vertical-middle"></i>Rechazar</a>
                                                                
                                                                
                                                            {% else %}
                                                                <a id="btPublish"
                                                                onclick="Publicar('{% url 'programacion_app:asignar' %}', '{{ row.id }}', '{{ row.estatus }}', '{{ row.folio}}', 0, '{{row.rfc}}', '{{row.nombre}}', '{{row.direccion}}');"
                                                                    class="dropdown-item" href="#">
                                                                    <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Publicar</a>
                                                            {% endif %}

                                                        {% elif permission == 'DIRECTOR' %}
                                                            <a id="btPublish"
                                                                onclick="Publicar('{% url 'programacion_app:asignar' %}', '{{ row.id }}', '{{ row.estatus }}', '{{ row.folio}}', 0, '{{row.rfc}}', '{{row.nombre}}', '{{row.direccion}}');"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Publicar</a>

                                                            <a id="btCancel"
                                                                onclick="Cancel_Modal('{% url 'programacion_app:alta-detalle' row.id %}', '{{ row.id }}', '{{ row.folio }}', '{{ row.rfc }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-reply me-2 text-muted font-18 vertical-middle"></i>Rechazar</a>
                                                            
                                                        {% endif %}
 
                                                        <a id="btDetail"
                                                         onclick="Ver_Detalle('{% url 'programacion_app:ver-autorizacion' row.id %}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="far fa-eye me-2 text-muted font-18 vertical-middle"></i>Detalle</a>       
                                                    </div>
                                                </div>
                                            </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="profile-30">

                            <div class="row">
                                <div class="form-floating col-md-12">
                                    <input id="search3" type="text" class="float-label form-control input-rec" placeholder=".">
                                    <label>Buscar</label>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" id="datatable3">
                                    <thead>
                                        <tr>
                                            <td class="all">Oficio</td>
                                            <td class="all">RFC</td>
                                            <td class="all">Nombre</td>
                                            <td class="all">Programa</td>
                                            <td class="all">Fecha Creación</td>
                                            <td class="all">Etapa</td>
											<td class="all">Area</td>
                                            <td class="all">Presuntiva</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for programa in revision %}
                                        <tr>
                                            <td>
                                                {% if programa.estatus == 'OFICIO' %}
                                                    {{ programa.folio|slice:"-9:" }}
                                                {% else %}
													{{ programa.id }}
                                                {% endif %}
                                            </td>
                                            <td>{{ programa.rfc }}</td>
                                            <td data-bs-toggle="tooltip" data-bs-placement="top" title="{{ programa.nombre }}">{{ programa.nombre|truncatechars:30 }}</td>
                                            <td>{{ programa.programa }}</td>
                                            <td><span class="sp_date">{{ programa.fecha|date:'Y/m/d' }}</span> {{programa.fecha|date:'d/m/Y' }}</td>
                                            <td>
                                                {% if programa.estatus == '1-RECHAZADA' or programa.estatus == '2-RECHAZADA' or programa.estatus == '3-RECHAZADA'%}
													RECHAZADA
												{% else %}
													{{ programa.estatus }}
												{% endif %}
                                            </td>
											<td>
												{% if programa.estatus == 'NUEVO' or programa.estatus == '1-RECHAZADA' or programa.estatus == '2-RECHAZADA' or programa.estatus == 'PROPUESTA'%}
													PROGRAMACION
												{% elif programa.estatus == 'FAFD' or programa.estatus == '3-RECHAZADA' or programa.estatus == 'OFICIO'%}
													VIGILANCIA
												{% elif programa.estatus == 'PRESUNTIVA' %}
													DIRECCION
												{% endif %}
                                            </td>
                                            <td>$&nbsp;{{ programa.presuntiva|unlocalize|intcomma }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>

                                </table>
                            </div>

                        </div>

                        <div class="tab-pane fade" id="en-proceso">    
                            
                            <div class="row">
                                <div class="form-floating col-md-12">
                                    <input id="search1" type="text" class="float-label form-control input-rec" placeholder=".">
                                    <label>Buscar</label>
                                </div>
                            </div>

                            <div class="table-responsive pt-3">
                                <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" id="datatable1">
                                    <thead>
                                        <tr>
                                            <td></td>
                                            <td>RFC</td>
                                            <td>Programa</td>
                                            <td>Fecha Inicio</td>
                                            <td>Estatus</td>
                                            <td>Impuestos</td>
                                            <td>Monto</td>
                                            <td class="hidden-sm">Acciones</td>
                                        </tr>
                                    </thead>
                                    <tbody>                                        
                                        {% for programa in en_proceso %}
                                        <tr>
                                            <td></td>
                                            <td>{{ programa.rfc }}</td>
                                            <td>{{ programa.programa }}</td>
                                            <td>{{ programa.fecha_inicio|date:'d/m/Y' }}</td>
                                            <td>{{ programa.estatus }}</td>
                                            <td id="tooltips-container">
                                                <div class="avatar-group">
                                                    {% for item in programa.impuestos %}
                                                    <a onclick="Impuestos('{% url 'programacion_app:impuestos' programa.id %}', '{{ programa.rfc }}', '{{ programa.id }}', '{{ item }}')"
                                                         class="avatar-group-item mb-0" data-bs-container="#tooltips-container" href="#"
                                                        data-bs-toggle="tooltip" data-bs-placement="top" title="{{ item }}">
                                                        <div class="avatar-xs">
                                                            <span style="background-color: var(--verde_claro);"
                                                                class="avatar-title text-secondary font-20 rounded-circle" alt="friend"></span>
                                                        </div>
                                                    </a>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                            <td>$&nbsp;{{ programa.monto|unlocalize|intcomma }}</td>
                                            <td class="text-center">
                                                <div class="btn-group dropdown">
                                                    <a href="javascript: void(0);" class="table-action-btn dropdown-toggle arrow-none btn btn-light btn-sm"
                                                        data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #00000000; border: 0px solid;"><i class="mdi mdi-dots-horizontal"></i></a>
                                                    <div class="dropdown-menu dropdown-menu-end">
                                                        {% if programa.estatus == 'PROCEDENTE' %}
                                                        <a onclick="Impuestos('{% url 'programacion_app:impuestos' programa.id %}', '{{ programa.rfc }}', '{{ programa.id }}', '0')"
                                                            class="dropdown-item" href="#">
                                                            <i class="mdi mdi-file-table-box-multiple-outline me-2 text-muted font-18 vertical-middle"></i> Impuestos</a>
                                                            
                                                            {% if programa.impuestos %}
                                                            <a onclick="Agregar_Contribuyente('{% url 'programacion_app:alta-contribuyente' %}', '{{ programa.rfc }}')"
                                                                class="dropdown-item" href="#"><i class="fa fa-paper-plane me-2"></i> Nueva Propuesta</a>    
                                                            {% endif %}

                                                        {% elif programa.estatus == 'NO PROCEDENTE' %}
                                                        <!-- cargar archivos -->                                                         
                                                        <a onclick="CargarArchivos('{% url 'programacion_app:subir-archivos-programacion' programa.id %}', '{{ programa.id }}', '{{ programa.rfc }}')"
                                                            class="dropdown-item" href="#"><i
                                                                class="mdi mdi-file-upload-outline me-2 text-muted font-18 vertical-middle"></i> Archivos</a>

                                                        <a onclick="Confirmacion('{% url 'programacion_app:terminar' programa.id %}')"
                                                            class="dropdown-item" href="#"><i
                                                                class="mdi mdi-account-check-outline me-2 text-muted font-18 vertical-middle"></i> Cerrar</a>
                                                            
                                                        {% else %}
                                                        <a onclick="CerrarAnalisis('{% url 'programacion_app:terminar' programa.id %}', '{{ programa.rfc }}')"
                                                            class="dropdown-item" href="#"><i
                                                                class="mdi mdi-check-box-outline me-2 text-muted vertical-middle"></i> Resultado</a>
                                                        {% endif %}
                                                              
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% for x in rango %}
                                        <tr>
                                            <td><i class="mdi mdi-flip-h mdi-account me-2 btn-outline-secondary"></i></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                        
                                </table>
                            </div>
                        
                        </div>
                        {% if permission == 'EJECUTIVO ANALISIS' or permission == 'COORDINACION PROGRAMACION' or permission == 'DIRECTOR' %}
                        <div class="tab-pane fade" id="reporte">   
                            <div class="row">
                                <iframe title="Report Section" width="600" height="373.5" src="https://app.powerbi.com/view?r=eyJrIjoiNWYxNzk3MTItMTljMC00NmMzLWFkZmQtODQwNjFkOTVkMTNkIiwidCI6IjYyOGMwZTc3LTViNTUtNDRkZi04YmUxLWVjYTNiMzdiOWNkMCIsImMiOjR9" frameborder="0" allowFullScreen="true"></iframe>
                            </div>
                        </div>
                        {% endif %}
						
						<div class="tab-pane fade" id="por-cerrar">

                            <div class="row">
                                <div class="form-floating col-md-12">
                                    <input id="search5" type="text" class="float-label form-control input-rec" placeholder=".">
                                    <label>Buscar</label>
                                </div>
                            </div>

                            <div class="table-responsive pt-3">
                                <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" id="datatable5">
                                    <thead>
                                        <tr>
                                            <td class="all">Oficio</td>
                                            <td class="all">RFC</td>
                                            <td class="all">Nombre</td>
                                            <td class="all">Programa</td>
                                            <td class="all">Fecha Creación</td>
                                            <td class="all">Estatus</td>
                                            <td class="all">Presuntiva</td>
											<td class="all hidden-sm">Acciones</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for programa in por_cerrar %}
                                        <tr>
                                            <td>
                                                {% if programa.estatus == 'PAGO TOTAL' or programa.estatus == 'PARA TRANSFERIR' or programa.estatus == 'RECHAZADO' %}
                                                {{ programa.folio|slice:"-9:" }}
                                                {% else %}
                                                {{ programa.id }}
                                                {% endif %}
                                            </td>
                                            <td>{{ programa.rfc }}</td>
                                            <td data-bs-toggle="tooltip" data-bs-placement="top" title="{{ programa.nombre }}">{{ programa.nombre|truncatechars:30 }}</td>
                                            <td>{{ programa.programa }}</td>
                                            <td><span class="sp_date">{{ programa.fecha|date:'Y/m/d' }}</span> {{programa.fecha|date:'d/m/Y' }}</td>
                                            <td>{{ programa.estatus }}</td>
                                            <td>$&nbsp;{{ programa.presuntiva|unlocalize|intcomma }}</td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="btn-group dropdown">
                                                        <a href="javascript: void(0);" class="table-action-btn dropdown-toggle arrow-none btn btn-light btn-sm"
                                                            data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #00000000; border: 0px solid;"><i class="mdi mdi-dots-horizontal"></i></a>
                                                        <div class="dropdown-menu dropdown-menu-end">

                                                            {% if programa.estatus == 'PARA TRANSFERIR' or programa.estatus == 'RECHAZADO' %}
                                                            <a id="btCerrar"
                                                                onclick="Estatus_Cierre('{% url 'programacion_app:estatus-cierre' programa.id %}', '{{ programa.folio }}', '{{ programa.rfc }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Concluir</a>

                                                            {% else %}
                                                            <a id="btPublish"
                                                                onclick="Cerrar_Modal('{% url 'programacion_app:alta-cierre' programa.id %}', '{{ programa.id }}', '{{ programa.folio }}', '{{ programa.estatus }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Concluir</a>

                                                            {% endif %}

                                                            {% if programa.estatus == 'PARA TRANSFERIR' or programa.estatus == 'PAGO TOTAL' or programa.estatus == 'ACLARACION' %}
                                                            <a id="btCancel" onclick="Rechazar('{% url 'programacion_app:alta-detalle' programa.id %}', '{{ programa.id }}', '{{ programa.folio }}', '{{ programa.estatus }}', '{{ programa.rfc }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-reply me-2 text-muted font-18 vertical-middle"></i>Rechazar</a>

                                                            {% endif %}

                                                            <a id="btDetail" onclick="Ver_Detalle('{% url 'programacion_app:ver-autorizacion' programa.id %}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="far fa-eye me-2 text-muted font-18 vertical-middle"></i>Detalle</a>  
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
						
						<div class="tab-pane fade" id="solicitar-apoyo">

                            <div class="row">
                                <div class="form-floating col-md-12">
                                    <input id="search6" type="text" class="float-label form-control input-rec" placeholder=".">
                                    <label>Buscar</label>
                                </div>
                            </div>

                            <div class="table-responsive pt-3">
                                <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" id="datatable6">
                                    <thead>
                                        <tr>
                                            <td class="all">Oficio</td>
                                            <td class="all">RFC</td>
                                            <td class="all">Nombre</td>
                                            <td class="all">Programa</td>
                                            <td class="all">Fecha Creación</td>
                                            <td class="all">Estatus</td>
                                            <td class="all">Presuntiva</td>
											<td class="all hidden-sm">Acciones</td>
                                        </tr>
                                    </thead>
                                   <tbody>
                                        {% for programa in solicitar_apoyo %}
                                        <tr>
                                            <td>
                                                {{ programa.folio|slice:"-9:" }}
                                            </td>
                                            <td>{{ programa.rfc }}</td>
                                            <td data-bs-toggle="tooltip" data-bs-placement="top" title="{{ programa.nombre }}">{{ programa.nombre|truncatechars:30 }}</td>
                                            <td>{{ programa.programa }}</td>
                                            <td><span class="sp_date">{{ programa.fecha|date:'Y/m/d' }}</span> {{programa.fecha|date:'d/m/Y' }}</td>
                                            <td>
                                                {{ programa.estatus }}
                                            </td>
                                            <td>$&nbsp;{{ programa.presuntiva|unlocalize|intcomma }}</td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="btn-group dropdown">
                                                        <a href="javascript: void(0);" class="table-action-btn dropdown-toggle arrow-none btn btn-light btn-sm"
                                                            data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #00000000; border: 0px solid;"><i class="mdi mdi-dots-horizontal"></i></a>
                                                        <div class="dropdown-menu dropdown-menu-end">

                                                            <a id="btSolicitar"
                                                                onclick="Solicitar('{% url 'programacion_app:alta-solicitud' programa.id %}', '{{ programa.id }}', '{{ programa.folio }}', '{{ programa.rfc }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-paper-plane me-2 text-muted font-18 vertical-middle"></i>Solicitar</a>

                                                            {% if programa.estatus == 'SOLICITAR APOYO' %}
                                                            <a id="btCerrar"
                                                                onclick="Rechazar('{% url 'programacion_app:alta-detalle' programa.id %}', '{{ programa.id }}', '{{ programa.folio }}', '{{ programa.estatus }}', '{{ programa.rfc }}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="fa fa-reply me-2  text-muted font-18 vertical-middle"></i>Rechazar</a>
                                                            {% endif %}

                                                            <a id="btDetail" onclick="Ver_Detalle('{% url 'programacion_app:ver-todo' programa.id %}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="far fa-eye me-2 text-muted font-18 vertical-middle"></i>Detalle</a>  
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>

                                        </tr>
                                        {% endfor %}
                                    </tbody>

                                </table>
                            </div>

                        </div>
						
						<div class="tab-pane fade" id="reasignar-oficio">

                            <div class="row">
                                <div class="form-floating col-md-12">
                                    <input id="search7" type="text" class="float-label form-control input-rec" placeholder=".">
                                    <label>Buscar</label>
                                </div>
                            </div>

                            <div class="table-responsive pt-3">
                                <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" id="datatable7">
                                    <thead>
                                        <tr>
                                            <td class="all">Oficio</td>
                                            <td class="all">RFC</th>
                                            <td class="all">Nombre</td>
                                            <td class="all">Programa</td>
                                            <td class="all">Fecha Creación</td>
                                            <td class="all">Estatus</td>
											<td class="all">Seguimiento</td>
                                            <td class="all">Presuntiva</td>
											<td class="all hidden-sm">Acciones</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for programa in reasignar %}
                                        <tr>
                                            <td>
                                                {{ programa.folio|slice:"-9:" }}
                                            </td>
                                            <td>{{ programa.rfc }}</td>
                                            <td data-bs-toggle="tooltip" data-bs-placement="top" title="{{ programa.nombre }}">{{ programa.nombre|truncatechars:30 }}</td>
                                            <td>{{ programa.programa }}</td>
                                            <td><span class="sp_date">{{ programa.fecha|date:'Y/m/d' }}</span> {{programa.fecha|date:'d/m/Y' }}</td>
                                            <td>
                                                {{ programa.estatus }}
                                            </td>
											<td>{% get_user_info programa.seguimiento %}</td>
                                            <td>$&nbsp;{{ programa.presuntiva|unlocalize|intcomma }}</td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="btn-group dropdown">
                                                        <a href="javascript: void(0);" class="table-action-btn dropdown-toggle arrow-none btn btn-light btn-sm"
                                                            data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #00000000; border: 0px solid;"><i class="mdi mdi-dots-horizontal"></i></a>
                                                        <div class="dropdown-menu dropdown-menu-end">

                                                            <a onclick="Reasignar('{% url 'programacion_app:reasignar' %}', '{{ programa.id }}', '{% get_user_id programa.seguimiento %}', '{{programa.folio}}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="mdi mdi-account-reactivate me-2 text-muted font-18 vertical-middle"></i>Reasignar</a>  
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
						</div>
						
						<div class="tab-pane fade" id="profile-70">

                            <div class="row">
                                <div class="form-floating col-md-12">
                                    <input id="search4" type="text" class="float-label form-control input-rec" placeholder=".">
                                    <label>Buscar</label>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover m-0 table-centered dt-responsive nowrap w-100" id="datatable4">
                                    <thead>
                                        <tr>
                                            <td class="all">Oficio</th>
                                            <td class="all">RFC</td>
                                            <td class="all">Nombre</th>
                                            <td class="all">Programa</td>
                                            <td class="all">Fecha Creación</td>
                                            <td class="all">Presuntiva</td>
                                            <td class="all hidden-sm">Acciones</td> 
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for programa in canceladas %}
                                        <tr>
                                            <td>
                                                {{ programa.id }}
                                            </td>
                                            <td>{{ programa.rfc }}</td>
                                            <td data-bs-toggle="tooltip" data-bs-placement="top" title="{{ programa.nombre }}">{{ programa.nombre|truncatechars:30 }}</td>
                                            <td>{{ programa.programa }}</td>
                                            <td><span class="sp_date">{{ programa.fecha|date:'Y/m/d' }}</span> {{programa.fecha|date:'d/m/Y' }}</td>
                                            <td>$&nbsp;{{ programa.presuntiva|unlocalize|intcomma }}</td>
                                            <td>
                                                <div class="text-center">
                                                    <div class="btn-group dropdown">
                                                        <a href="javascript: void(0);" class="table-action-btn dropdown-toggle arrow-none btn btn-light btn-sm"
                                                            data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #00000000; border: 0px solid;"><i class="mdi mdi-dots-horizontal"></i></a>
                                                        <div class="dropdown-menu dropdown-menu-end">
                                                            <a id="btDetail" onclick="Ver_Detalle('{% url 'programacion_app:ver-autorizacion' programa.id %}')"
                                                                class="dropdown-item" href="#">
                                                                <i class="far fa-eye me-2 text-muted font-18 vertical-middle"></i>Detalle</a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>

                                </table>
                            </div>

                        </div>

                    </div>
            </div>
        </div>
    </div>
 </div>

<!-- Modal View -->
<div class="modal fade" id="mdView" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 10000;">
</div>

<div class="modal fade" id="mdRFC" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 10000;">
</div>

<div class="modal fade" id="mdFiles" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true" style="z-index: 10000;">
</div>

{% endblock content %}

{% block extrajs %}
<script src="{% static 'assets/libs/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/libs/datatables.net-bs5/js/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'assets/libs/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'assets/libs/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js' %}"></script>
<script src="{% static 'custom/js/render-table.js' %}"></script>

<script src="{% static 'assets/libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
<script src="{% static 'assets/libs/sweetalert2/sweetalert2.all.min.js' %}"></script>

<script>
    var modalConfirmacion = false;

    $(document).ready(function () {
        toastr.options = {
            "positionClass": "toast-bottom-right",
        }    
        // $("td").addClass('centrado');
		$('.sp_date').hide();

        // Propuestas de Contribuyentes
        render_table('#datatable1', '#search1', [6]);

		// Propuestas FAFD
        render_table('#datatable2', '#search2', [7]);

        // Revisión
		render_table('#datatable3', '#search3', []);

        // Canceladas
		render_table('#datatable4', '#search4', [5]);

        // Por Cerrar
		render_table('#datatable5', '#search5', [5]);

        // Solicitar Apoyo
		render_table('#datatable6', '#search6', [5]);

        // Reasignar
		render_table('#datatable7', '#search7', [5]);

        {% if messages %}
            {% for message in messages %}
                {% if message.tags == 'info' %}
                    {% if message|safe == 'en_proceso' %}
                        $('#en-proceso-tab').tab('show');                
                    {% elif message|safe == 'archivos' %}  
                        $('#en-proceso-tab').tab('show');
                    {% elif message|safe == 'por_cerrar' %}  
                        $('#por-cerrar-tab').tab('show');
                    {% endif %}
                {% elif message.tags == 'success' %}                    
                    toastr.success('{{ message|safe }}')
                {% endif %}
            {% endfor %}
        {% endif %}

    });

    function Ver_Detalle(myURL) {
        $('#mdView').load(myURL, function () {
            $(this).modal('show');
        });
    }

    function Agregar_Contribuyente(myURL, myRFC = null) {
        $('#mdRFC').load(myURL, function () {
            $('#id_rfc').val(myRFC);
            $('#id_fecha').hide();
            $('.date-picker-default').datepicker({ 
                format: 'dd/mm/yyyy' 
            });
            $(this).modal('show');
        });
    }

    function Add_Modal(myURL, myOption) {
        // if (myURL == "/elegir/1/" && {{en_proceso.count}} >= 15){
        //     toastr.error("Solo se permiten 15 en proceso","Denegado", { positionClass: "toast-bottom-right" });
        //     //return;
        // }
        var path = "{% url 'programacion_app:validar-dato' 'RFC' 0 %}";

		$.ajax({
            url: path, 
            type: "GET", 
            dataType: "JSON", 
            success: function (data) { 
                if (data.result === true){
                    $('#mdRFC').load(myURL, function () {
                        $('#id_fecha').hide();
                        $('.date-picker-default').datepicker({ 
                            format: 'dd/mm/yyyy' 
                        });
                        $('.date-picker-default').css("background-color", "white");
                        $(this).modal('show');

                    });
                }else{
                    toastr.options = {
                        "closeButton": true,
                        "positionClass": "toast-bottom-right",
                        "tapToDismiss": false
                    }
                    toastr.warning('No hay RFCs Disponibles')
                }
            }, 
            error: function (error) { 
				console.log(error);
            } 			
        });
    }
	
	function Rechazar(myURL, myID, myFolio, myStatus, myRFC) {
        $('#mdView').load(myURL, function () {

            var myEstatus = $(document.getElementById('id_estatus'))[0].selectize;

            if(myStatus == 'PARA TRANSFERIR' | myStatus == 'PAGO TOTAL' | myStatus == 'ACLARACION'){
                myEstatus.removeOption(39);
                myEstatus.removeOption(40);
                myEstatus.removeOption(72);
            }
			if(myStatus == 'SOLICITAR APOYO'){
                myEstatus.removeOption(39);
                myEstatus.removeOption(40);
                myEstatus.removeOption(72);
            }
            myEstatus.setValue(88);
			
            $("#lbOficio").html(myFolio);
            $("#lbRFC").html(myRFC);
            $("#lbTitle").html("Rechazar");
            $('#textarea').attr('required', true);
            $("#id_programa_id option[value='" + myID + "']").attr('selected', 'selected');
            $("#id_programa_id").hide();
            $('#id_fecha').hide();
            $('#select_etapa').hide();
            $('#lbFecha').hide();
            $('#lbEtapa').hide();
            $('.date-picker-default').datepicker({
                format: 'dd/mm/yyyy'
            });
            $('.date-picker-default').css("background-color", "#white");

            $(this).modal('show');
        });
    }

    function Cancel_Modal(myURL, myID, myFolio, myRFC) {
        $('#mdView').load(myURL, function () {

            $("#lbOficio").html(myID);
            $("#lbRFC").html(myRFC);
            
            var myEstatus = $(document.getElementById('id_estatus'))[0].selectize;
            myEstatus.removeOption(39);
            myEstatus.removeOption(40);
            myEstatus.removeOption(88);

            $("#lbTitle").html("Rechazar");
            $('#textarea').attr('required', true);
            $("#id_programa_id option[value='" + myID + "']").attr('selected', 'selected');
            $("#id_programa_id").hide();
            $('#id_fecha').hide();
            $('#lbFecha').hide();
            $('#select_etapa').hide();
            $('#lbEtapa').hide();
            $('.date-picker-default').datepicker({
                format: 'dd/mm/yyyy'
            });
            $('.date-picker-default').css("background-color", "#white");

            $(this).modal('show');
        });
    }

    function Estatus_Cierre(myURL, myFolio, myRFC) {
        $('#mdView').load(myURL, function () {
            $('#id_estatus option[value="39"]').remove();
            $("#lbFolio").html(myFolio);
            $("#lbRFC").html(myRFC);
            
            $(this).modal('show');
        });
    }
	
	function Cerrar_Modal(myURL, myID, myFolio, myStatus) {
        $('#mdView').load(myURL, function () {
            if(myStatus == 'PARA TRANSFERIR' | myStatus == 'RECHAZADO'){
                $('#id_estatus option[value="39"]').remove();
            }else if(myStatus == 'ACLARACION'){
                $('#id_estatus option[value="72"]').remove();
            }else{
                $('#id_estatus option[value="187"]').remove();
            }
	
			if(myStatus == 'SOLICITAR APOYO'){
				$('#lbEstatus').hide();
				$('#id_estatus').hide();
            }
		
            var entries = 'Oficio: ' + myFolio;
            $("#lbSelected4").html(entries);
            
            $("#id_programa_id option[value='" + myID + "']").attr('selected', 'selected');
            $("#id_programa_id").hide();

            $('#tbID4').hide();
            $('#id_fecha').hide();
            $('#lbFecha2').hide();
            $('#lbOficio2').hide();

            $('.date-picker-default').datepicker({
                format: 'dd/mm/yyyy'
            });
            $('.date-picker-default').css("background-color", "#white");
			
            $(this).modal('show');
        });
    }
	
    function CerrarAnalisis(myURL, myRFC) {
        $('#mdView').load(myURL, function () {
            $("#lbRFC").html(myRFC);
            $(this).modal('show');
        });        
    }

    function Impuestos(myURL, myRFC, myID, myImpuesto) {
        $('#mdView').load(myURL, function () {

            $('#hfImpuesto').val(myImpuesto);
            $("#lbContribuyente").html(myRFC);
            $('#hfContribuyente').val(myID);
            
            $(this).modal('show');
        });
    }

    function CargarArchivos(myURL, myID, myRFC) {
        $('#mdFiles').load(myURL, function () {
            $("#lbRFC").html(myRFC);
            $(this).modal('show');
        });
    }
    
	function Solicitar(myURL, myID, myFolio, myRFC) {
        $('#mdView').load(myURL, function () {
            $("#lbOficio").html(myFolio);
            $("#lbRFC").html(myRFC);
            
            $("#id_programa_id option[value='" + myID + "']").attr('selected', 'selected');
            $("#id_programa_id").hide();

            $('#id_fecha').hide();
			$('#lbFecha2').hide();
                        
            $('.date-picker-default').datepicker({
                format: 'dd/mm/yyyy'
            });
            $('.date-picker-default').css("background-color", "#white");
			
            $(this).modal('show');
        });
    }

    function Editar_Contribuyente(myURL) {
        $('#mdView').load(myURL, function () {
            $('.date-picker-default').datepicker({
                format: 'dd/mm/yyyy'
            });
            $('#id_fecha').hide();
            $('#id_rfc').prop('readonly', 'readonly');
            $(this).modal('show');
        });
    }

    function Publicar(myURL, myList, myStatus, myFolio, myFlag, myRFC, myNombre, myDireccion) {

            var path = "{% url 'rec_app:get-fiscalizados' 'RFC' %}";
			
			$.ajax({
                url: path.replace('RFC', myRFC), 
                type: "GET", 
                dataType: "JSON", 
                success: function (data) { 
                    
					if (data[0]){ 
						var rfc_ = data[0].fields.rfc; 

                        Swal.fire({
                            position: "top-center",
                            icon: "error",
                            title: 'Este RFC necesita autorizacion: ' + rfc_,
                            Text: rfc_,
                            showConfirmButton: !1,
                        });
					} 
                   
                }, 
                error: function (error) { 
					console.log(error);
                } 
			});
            
			
        $('#mdView').load(myURL, function () {
            
            // if(myFolio==''){
            //     var entries = myList;
            // }else{
            //     var entries = myFolio;
            // }
			// $("#lbOficio").html(entries);
            $("#lbRFC").html(myRFC);
            $("#lbNombre").html(myNombre);
            $("#lbDireccion").html(myDireccion);

            $("#id_lista").val(myList);

            if(myStatus.indexOf("RECHAZADA") > 0){
        
                $('#lbCmmt').show();
                $('#textarea').attr('required', true);
                $('#textarea').show();

                $('#select_seguimiento').hide();
                $('#lbAsignar').hide();

            }else if(myStatus == 'NUEVO' | myStatus == 'PROPUESTA' | myStatus == 'FAFD' | myStatus == 'PRESUNTIVA'){

                $('#lbCmmt').show();
                $('#textarea').show();

                $('#select_seguimiento').hide();
                $('#lbAsignar').hide();
                
            }else if(myStatus == "OFICIO" | myStatus == "REACTIVADO" | myFlag == 1){
                $('#lbAsignar').show();
                $('#select_seguimiento').show();
                $('#hfValidar').val('1');
                
                $('#lbCmmt').hide();
                $('#textarea').hide();  
            }else{
                $('#textarea').attr('required', false);
                $('#textarea').hide();

                $('#lbCmmt').hide();
                $('#select_seguimiento').hide();
                $('#lbAsignar').hide();
            }
                   
            $(this).modal('show');
        });
    }
	
	function Reasignar(myURL, myList, myUser, myFolio) {
        $('#mdView').load(myURL, function () {
            
			$("#lbOficio").html(myFolio);
            $("#id_lista").val(myList);

            var mySeguimiento = $(document.getElementById('id_seguimiento'))[0].selectize;
            mySeguimiento.setValue(myUser);
			// $("#id_seguimiento option:contains('" + myUser + "')").attr('selected','selected');
           
            $(this).modal('show');
        });
    }
    
    function mostrarMotivo(control){
        if (control.value != '232'){
            $("#cmb_Motivo").hide();   
            return;
        }
        
        $("#cmb_Motivo").show();        
    }

    function Confirmacion(url){
        if (modalConfirmacion){
            return
        }
        modalConfirmacion = true;
        
        toastr.options = {
            "closeButton": true,
            "positionClass": "toast-top-center",
        }
        toastr.warning(`<br><button type='button' id='confirmationButtonYes' class='btn btn btn-outline-secondary waves-effect btn-volver'>Confirmar</button>
        <button type='button' id='confirmationButtonNo' class='btn btn btn-outline-secondary waves-effect btn-volver mx-3'>Cancelar</button>`,`Cerrar Contribuyente?`,
        {
            closeButton: false,
            allowHtml: true,
            onShown: function (toast) {
                $("#confirmationButtonYes").click(function(){
                    
                $.ajax({
                    url: url, 
                    type: "DELETE", 
                    dataType: "JSON",
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }, 
                    success: function (data) { 
                        location.reload();
                    }, 
                    error: function (error) { 
                        console.log(error);
                    } 			
                });
                
                });
                $("#confirmationButtonNo").click(function(){
                    toastr.clear();
                    modalConfirmacion = false;
                });
            }
        });
    }
</script>
{% endblock extrajs %}
